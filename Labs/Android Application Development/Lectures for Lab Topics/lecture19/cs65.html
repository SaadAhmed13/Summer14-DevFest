<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <meta name="generator" content="pandoc">
  <title></title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; }
code > span.dt { color: #902000; }
code > span.dv { color: #40a070; }
code > span.bn { color: #40a070; }
code > span.fl { color: #40a070; }
code > span.ch { color: #4070a0; }
code > span.st { color: #4070a0; }
code > span.co { color: #60a0b0; font-style: italic; }
code > span.ot { color: #007020; }
code > span.al { color: #ff0000; font-weight: bold; }
code > span.fu { color: #06287e; }
code > span.er { color: #ff0000; font-weight: bold; }
  </style>
  <link rel="stylesheet" href="db-simple.css" type="text/css">
</head>
<body>
<div id="header">

<div id="sitetitle"><b>Dartmouth CS 65/165</b></div>
<div id="container">
<div id="sitesubtitle"><b>Smartphone Programming</b></div>
<div id="siterightheader"><b>Professor Andrew T. Campbell</b></div>
</div>

<div class="clearer"><!-- --></div>


<hr>
</div>
<h2 id="services-and-notifications">Services and Notifications</h2>
<p>In this lecture, we discuss a number of building blocks for MyRunds and any complex Android app:</p>
<ol style="list-style-type: decimal">
<li><a href="http://developer.android.com/guide/components/services.html">Services</a>: are part of the application and run on a different thread in the background and supports some long-running operation, such as, handling location updates from the LocationManager as in the case of MyRuns. Typically, services operate outside of the user interface.</li>
<li><a href="http://developer.android.com/guide/topics/ui/notifiers/notifications.html">Notification</a> allows apps or services associated with an app to inform the user of an event.</li>
</ol>
<p><strong>Note, these are incomplete notes -- to be updated.</strong></p>
<h2 id="what-this-lecture-will-teach-you">What this lecture will teach you</h2>
<ul>
<li>Interacting with the status bar</li>
<li>Notify Demo</li>
</ul>
<h2 id="demo-projects">Demo projects</h2>
<p>The demo code used in this lecture include:</p>
<ul>
<li>We will use the <a href="..\code\notifydemo.zip">notifydemo.zip</a> app to demonstrate how to interact with the status bar.</li>
</ul>
<h2 id="resources">Resources</h2>
<p>Some excellent references.</p>
<ul>
<li>Course book section on <a href="http://commonsware.com/Android/">Introducing Notifications</a> page 405</li>
<li>Developers discussion of <a href="http://developer.android.com/guide/topics/ui/notifiers/notifications.html">notifications</a></li>
</ul>
<h2 id="interacting-with-the-status-bar">Interacting with the status bar</h2>
<p>Android supports a number of different ways to inform the user including:</p>
<ol style="list-style-type: decimal">
<li>Staus bar at the top of the UI, owned and managed by the Android system but apps can display messages or icon in the notification area.</li>
<li>Play sounds, uses lights and vibrate the phone to inform the user of an app related event</li>
<li>Notification tray or drawer which allows the app to present more information and certain control elements such as navigating back to the main app, that is, bring the app back into focus if its paused.</li>
</ol>
<p>We will focus on the status bar notification in this lecture. You will need to implement this type of notification for MyRuns4.</p>
<p>Typically a programmer develops an app and needs to inform the user of an event that is outside of the normal UI. For example if we consider MyRuns4 that you are coding right now. When the user starts an exercise using the GPS mode (or automatic) the code creates a service to process location updates. When this service starts on an independent thread in the background it informs the user that it is running by display first message (i.e., &quot;MyRuns is recording your path&quot; ) and then an icon (i.e., the D icon) in the <strong>notification area</strong>. We can see this below</p>
<div class="figure">
<img src="images\status.png">
</div>
<p>To see the details of the MyRuns4 notification, the user needs to wipe down on the status bar (i.e., notification area) to open the <strong>notification drawer</strong>. The system controls the notification area and drawer and allows the user to view and interact with it at any point For example, in the case of MyRuns4 notification in the drawer the user can wipe down the status bar and click on the MyRuns notification in the drawer and it bring the app back into focus, as shown in the image below.</p>
<div class="figure">
<img src="images\drawer.png">
</div>
<h2 id="notify-demo-app">Notify demo app</h2>
<p>The simple notification app used in this lecture uses the status bar to inform the user that a service has been started (we will discuss services next). When the user starts the service an icon is displayed in the status bar. If you wipe down the status bar you will see that the notification drawer for the service displays an icon and text (i.e., Demo of Notification! course website). If you click on this notification the service will launch a browser to display the class webpage.</p>
<p>When the app starts up there is no service running and nothing in the status bar associated with the notify app, as shown below.</p>
<div class="figure">
<img src="images\notify1.png">
</div>
<p>When the user starts the service the icon shows up in the status bar or notification area, as shown in the image below.</p>
<div class="figure">
<img src="images\notify3.png">
</div>
<p>The user can wipe down the status bar and click on the notification which triggers the service to start the browser with the course page, as illustrated in the digram below.</p>
<div class="figure">
<img src="images\notify2.png">
</div>
<p>In addition, the user could mindlessly ;-) start and stop the service and see the icon come and go -- be mindless, just do it.</p>
<p>This simple application introduces a number of new things. Importantly a background service is started to interact with the status bar. In MyRuns4 we will implement a service to manage location updated from the LocationManager.</p>
<p>Let's look at the code.</p>
<h2 id="notify-activity">Notify activity</h2>
<p>The activity simply takes input from the user and starts and stops the service.</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> NotifyActivity <span class="kw">extends</span> Activity {
    <span class="co">/** Called when the activity is first created. */</span>
    @Override
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">onCreate</span>(Bundle savedInstanceState) {
        <span class="kw">super</span>.<span class="fu">onCreate</span>(savedInstanceState);
        <span class="fu">setContentView</span>(R.<span class="fu">layout</span>.<span class="fu">main</span>);
        Button buttonStartService = (Button)<span class="fu">findViewById</span>(R.<span class="fu">id</span>.<span class="fu">startservice</span>);
        Button buttonStopService = (Button)<span class="fu">findViewById</span>(R.<span class="fu">id</span>.<span class="fu">stopservice</span>);
        
        buttonStartService.<span class="fu">setOnClickListener</span>(<span class="kw">new</span> Button.<span class="fu">OnClickListener</span>(){

            @Override
            <span class="kw">public</span> <span class="dt">void</span> <span class="fu">onClick</span>(View arg0) {
            
                Intent intent = <span class="kw">new</span> <span class="fu">Intent</span>(NotifyActivity.<span class="fu">this</span>, NotifyService.<span class="fu">class</span>);
                NotifyActivity.<span class="fu">this</span>.<span class="fu">startService</span>(intent);
            }});
        
        buttonStopService.<span class="fu">setOnClickListener</span>(<span class="kw">new</span> Button.<span class="fu">OnClickListener</span>(){

            @Override
            <span class="kw">public</span> <span class="dt">void</span> <span class="fu">onClick</span>(View arg0) {
            
                Intent intent = <span class="kw">new</span> <span class="fu">Intent</span>();
                intent.<span class="fu">setAction</span>(NotifyService.<span class="fu">ACTION</span>);
                intent.<span class="fu">putExtra</span>(NotifyService.<span class="fu">STOP_SERVICE_BROADCAST_KEY</span>, 
                            NotifyService.<span class="fu">RQS_STOP_SERVICE</span>);

                    <span class="co">// Broadcast the given intent to all interested BroadcastReceivers</span>
                <span class="fu">sendBroadcast</span>(intent);

            }});
        
    }
}</code></pre>
<h2 id="notify-service">Notify Service</h2>
<p>The activity starts and stops in the service. A broadcast is used to stop the service; that is, the activity sends an intent to all interested BroadcastReceivers with stop command. In our example, on the service is listening on this broadcast and implements a <strong>BroadcastReceiver</strong></p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> NotifyService <span class="kw">extends</span> Service {
    
    <span class="dt">final</span> <span class="dt">static</span> String ACTION = <span class="st">&quot;NotifyServiceAction&quot;</span>;
    <span class="dt">final</span> <span class="dt">static</span> String STOP_SERVICE_BROADCAST_KEY=<span class="st">&quot;StopServiceBroadcastKey&quot;</span>;
    <span class="dt">final</span> <span class="dt">static</span> <span class="dt">int</span> RQS_STOP_SERVICE = <span class="dv">1</span>;
    
    NotifyServiceReceiver notifyServiceReceiver;
    


    <span class="kw">private</span> <span class="dt">final</span> String myBlog = <span class="st">&quot;http://www.cs.dartmouth.edu/~campbell/cs65/cs65.html&quot;</span>;
    
    @Override
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">onCreate</span>() {
        
        notifyServiceReceiver = <span class="kw">new</span> <span class="fu">NotifyServiceReceiver</span>();
        <span class="kw">super</span>.<span class="fu">onCreate</span>();
    }

    @Override
    <span class="kw">public</span> <span class="dt">int</span> <span class="fu">onStartCommand</span>(Intent intent, <span class="dt">int</span> flags, <span class="dt">int</span> startId) {
    
        
        IntentFilter intentFilter = <span class="kw">new</span> <span class="fu">IntentFilter</span>();
        intentFilter.<span class="fu">addAction</span>(ACTION);
        <span class="fu">registerReceiver</span>(notifyServiceReceiver, intentFilter);
        
        <span class="co">// Send Notification</span>
        String notificationTitle = <span class="st">&quot;Demo of Notification!&quot;</span>;
        String notificationText = <span class="st">&quot;Course Website&quot;</span>;
        Intent myIntent = <span class="kw">new</span> <span class="fu">Intent</span>(Intent.<span class="fu">ACTION_VIEW</span>, Uri.<span class="fu">parse</span>(myBlog));
        PendingIntent pendingIntent 
                = PendingIntent.<span class="fu">getActivity</span>(<span class="fu">getBaseContext</span>(), 
                        <span class="dv">0</span>, myIntent, 
                        Intent.<span class="fu">FLAG_ACTIVITY_NEW_TASK</span>);
        
        
        
        
        Notification notification = <span class="kw">new</span> Notification.<span class="fu">Builder</span>(<span class="kw">this</span>)
        .<span class="fu">setContentTitle</span>(notificationTitle)
        .<span class="fu">setContentText</span>(notificationText).<span class="fu">setSmallIcon</span>(R.<span class="fu">drawable</span>.<span class="fu">icon</span>)
        .<span class="fu">setContentIntent</span>(pendingIntent).<span class="fu">build</span>();
        NotificationManager notificationManager = 
                  (NotificationManager) <span class="fu">getSystemService</span>(NOTIFICATION_SERVICE);
        notification.<span class="fu">flags</span> = notification.<span class="fu">flags</span>
                | Notification.<span class="fu">FLAG_ONGOING_EVENT</span>;
        notification.<span class="fu">flags</span> |= Notification.<span class="fu">FLAG_AUTO_CANCEL</span>;
        
        notificationManager.<span class="fu">notify</span>(<span class="dv">0</span>, notification); 
        
        <span class="kw">return</span> <span class="kw">super</span>.<span class="fu">onStartCommand</span>(intent, flags, startId);
    }

    @Override
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">onDestroy</span>() {
    
        <span class="kw">this</span>.<span class="fu">unregisterReceiver</span>(notifyServiceReceiver);
        <span class="kw">super</span>.<span class="fu">onDestroy</span>();
    }

    @Override
    <span class="kw">public</span> IBinder <span class="fu">onBind</span>(Intent arg0) {
        
        <span class="kw">return</span> <span class="kw">null</span>;
    }

    <span class="kw">public</span> <span class="kw">class</span> NotifyServiceReceiver <span class="kw">extends</span> BroadcastReceiver{

        @Override
        <span class="kw">public</span> <span class="dt">void</span> <span class="fu">onReceive</span>(Context arg0, Intent arg1) {
        
            <span class="dt">int</span> rqs = arg1.<span class="fu">getIntExtra</span>(STOP_SERVICE_BROADCAST_KEY, <span class="dv">0</span>);
            
            <span class="kw">if</span> (rqs == RQS_STOP_SERVICE){
                <span class="fu">stopSelf</span>();
                ((NotificationManager) <span class="fu">getSystemService</span>(NOTIFICATION_SERVICE))
                .<span class="fu">cancelAll</span>();
            }
        }
    }
    
}</code></pre>
<h2 id="service-defined-in-manifest">Service defined in Manifest</h2>
<p>A service needs to be defined in the manifest as shown below.</p>
<pre class="sourceCode java"><code class="sourceCode java">&lt;?xml version=<span class="st">&quot;1.0&quot;</span> encoding=<span class="st">&quot;utf-8&quot;</span>?&gt;
&lt;manifest xmlns:android=<span class="st">&quot;http://schemas.android.com/apk/res/android&quot;</span>
      <span class="kw">package</span>=&quot;edu.dartmouth.cs.notifydemo&quot;
      android:versionCode=<span class="st">&quot;1&quot;</span>
      android:versionName=<span class="st">&quot;1.0&quot;</span>&gt;
    &lt;uses-sdk android:minSdkVersion=<span class="st">&quot;17&quot;</span> /&gt;

    &lt;application android:icon=<span class="st">&quot;@drawable/icon&quot;</span> android:label=<span class="st">&quot;@string/app_name&quot;</span>&gt;
        &lt;activity android:name=<span class="st">&quot;edu.dartmouth.cs.notifydemo.NotifyActivity&quot;</span>
                  android:label=<span class="st">&quot;@string/app_name&quot;</span>&gt;
            &lt;intent-filter&gt;
                &lt;action android:name=<span class="st">&quot;android.intent.action.MAIN&quot;</span> /&gt;
                &lt;category android:name=<span class="st">&quot;android.intent.category.LAUNCHER&quot;</span> /&gt;
            &lt;/intent-filter&gt;
        &lt;/activity&gt;
        &lt;service android:name=<span class="st">&quot;edu.dartmouth.cs.notifydemo.NotifyService&quot;</span>/&gt;
    &lt;/application&gt;
&lt;/manifest&gt;</code></pre>
<h2 id="binder">Binder</h2>
<p>The application binds to a sr</p>
<pre class="sourceCode java"><code class="sourceCode java"></code></pre>
<pre class="sourceCode java"><code class="sourceCode java"></code></pre>
</body>
</html>
